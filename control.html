<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¡œå’Œä¼š2025 æ­“é€è¿ä¼š åº§å¸­ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="./firebase-config.js"></script>
  <style>
    body { margin:0; padding:1em; font-family:sans-serif; background:#e3f2fd; text-align:center; color:#333; }
    h1   { margin:.2em 0 .8em; font-size:1.6em; }
    #nameButtons {
      display:grid;
      grid-template-columns:repeat(8,1fr);
      gap:10px; max-width:900px; margin:0 auto 1.5em;
    }
    #nameButtons button {
      padding:14px; border:none; border-radius:10px;
      background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.1);
      font-size:1em; white-space:nowrap;
      transition:transform .1s;
    }
    #nameButtons button:hover:not(:disabled) { transform:scale(1.05); background:#bbdefb; cursor:pointer; }
    #nameButtons button.selected { background:#42a5f5; color:#fff; }
    #nameButtons button:disabled { background:#eee; color:#999; }
    #nameButtons button.long { font-size:.85em; }

    #lotteryBtn {
      padding:18px 30px; font-size:1.4em; border:none; border-radius:10px;
      width:90%; max-width:600px; color:#fff; background:#1e88e5; margin-bottom:1em;
    }
    #lotteryBtn.stop { background:#e53935; }

    #result { font-size:1.5em; margin-bottom:1em; }
  </style>
</head>
<body>
  <h1>æ¡œå’Œä¼š2025 æ­“é€è¿ä¼š åº§å¸­ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
  <div id="nameButtons"></div>
  <button id="lotteryBtn">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
  <div id="result"></div>

<script>
(() => {
  const fixedAssignments = {
    "ç”°ä¸­æ ¡é•·": "B1",
    "ç¦åŸæ•™é ­": "A1",
    "å¹³äº•äº‹å‹™é•·": "B2",
    "å·å£å‰æ ¡é•·": "A2"
  };
  const fixedSeatSet = new Set(Object.values(fixedAssignments));

  // é™¤å¤–ã•ã‚ŒãŸå¹¹äº‹6åã‚’å‰Šé™¤æ¸ˆã¿ã®å‚åŠ è€…ãƒªã‚¹ãƒˆ
  const knownMembers = [
    "ä¸Šåœ’","äº•ä¸Š","ä¼Šè—¤é”","ä¼´ç”°","å†…æµ·","åŠ è—¤é›ª","å‹‡å£«","å—è¿«","ç”°ä¸­ç¤¼",
    "å³è¡›é–€ä½","å‰æ¾¤","å‰ç”°æ­","å‰ç”°é‡Œ","åŸ","å ¤","å¢—ç”°","å¤§æ©‹","å¤§æµ¦","å¤ªç”°å¾¹","å¥¥å±±","å®®ç•‘",
    "å²¡ç”°","å²¡","å·æ‘","å¹³äº•äº‹å‹™é•·","æŠ¼å²¡","æ˜è²","æ±å±±","æ±","æ¾ä¸‹","æ¾æ‘","æŸ¿æœ¨",
    "æ¢…æ‘","æ£®è¥¿","æ²³æ·»","æ³‰è°·","æ¸¡è¾º","åŒ—åŸ","æ¿±ç”°","ç‰å·","ç”°ä¸­æ ¡é•·","åªç”°","ç¦åŸæ•™é ­",
    "ç«‹çŸ³","ç«¹æœ¬","ç´€å¤ª","èŠ±å´","è—¤ç”°","è±•ç€¬","æ«»äº•","é‡å£","æ¿±ä¸­","å³¶ç”°","æ¡è°·","å·å£å‰æ ¡é•·",
    "å²¡æœ¬","æ¾æœ¬","å¤ªç”°ç¾","è‰è–™","ä¼Šè—¤æ™º","å¥¥é‡","ç”°ä¸­åƒ","ãƒãƒ¼ã‚«ã‚¹"
  ];

  // å…¨å¸­ãƒªã‚¹ãƒˆï¼ˆå›ºå®šå¸­ã‚’é™¤å¤–ï¼‰
  const allSeats = [];
  "ABCDEFGHIJKL".split("").forEach(block => {
    let count = 10;
    if (["A","B","C","D"].includes(block)) count = 5;
    else if (["E","F","G","H"].includes(block)) count = 4;
    else if (["I","J"].includes(block)) count = 6;
    else if (block === "K") count = 8;
    else if (block === "L") count = 7;
    for (let i = 1; i <= count; i++) {
      const code = `${block}${i}`;
      if (!fixedSeatSet.has(code)) allSeats.push(code);
    }
  });

  const App = {
    selectedName: null,
    timer: null,
    spinOrder: [],
    spinIndex: 0,

    secureShuffle(arr) {
      const a = arr.slice();
      const u32 = new Uint32Array(1);
      for (let i = a.length - 1; i > 0; i--) {
        window.crypto.getRandomValues(u32);
        const j = u32[0] % (i + 1);
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    },

    renderButtons(assigned = {}) {
      const wrap = document.getElementById("nameButtons");
      wrap.innerHTML = "";
      knownMembers.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        if (name.length >= 4) btn.classList.add("long");
        btn.disabled = Boolean(assigned[name]);
        btn.onclick = () => {
          App.selectedName = name;
          document.querySelectorAll("#nameButtons button")
                  .forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          document.getElementById("result").textContent = `${name}å…ˆç”Ÿã‚’é¸æŠä¸­â€¦`;
        };
        wrap.appendChild(btn);
      });
    },

    start() {
      if (!App.selectedName) return alert("å…ˆã«åå‰ã‚’é¸ã‚“ã§ãã ã•ã„");
      const btn = document.getElementById("lotteryBtn");
      btn.textContent = "ã‚¹ãƒˆãƒƒãƒ—";
      btn.classList.add("stop");
      btn.onclick = App.stop;

      firebase.database().ref("assignments").once("value").then(snap => {
        const assigned = snap.val() || {};
        if (assigned[App.selectedName]) {
          alert("ã™ã§ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ã™");
          return;
        }

        const fixedSeat = fixedAssignments[App.selectedName];
        const pool = fixedSeat ? allSeats
                                : allSeats.filter(s => !Object.values(assigned).includes(s));
        App.spinOrder = App.secureShuffle(pool);
        App.spinIndex = 0;

        App.timer = setInterval(() => {
          const seat = App.spinOrder[App.spinIndex % App.spinOrder.length];
          document.getElementById("result").textContent =
            `${App.selectedName}å…ˆç”Ÿ â†’ ${seat.charAt(0)}`;
          App.spinIndex++;
        }, 100);
      }).catch(err => {
        console.error("DB read error", err);
        alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      });
    },

    stop() {
      clearInterval(App.timer);
      const btn = document.getElementById("lotteryBtn");
      btn.textContent = "ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹";
      btn.classList.remove("stop");
      btn.onclick = App.start;
      btn.disabled = true;
      setTimeout(() => { btn.disabled = false; }, 2000);

      const idx = App.spinIndex % App.spinOrder.length;
      const finalSeat = fixedAssignments[App.selectedName] || App.spinOrder[idx];
      console.log(`[LOG] ${App.selectedName} â†’ ${finalSeat}`);

      firebase.database().ref("assignments/" + App.selectedName)
        .set(finalSeat)
        .then(() => {
          document.getElementById("result").textContent =
            `ğŸ‰ ${App.selectedName}å…ˆç”Ÿã®å¸­ã¯ ${finalSeat.charAt(0)} ã«æ±ºå®šï¼`;
          App.selectedName = null;
        })
        .catch(err => {
          console.error("DB write error", err);
          alert("å‰²ã‚Šå½“ã¦ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
        });
    }
  };

  firebase.database().ref("assignments").on("value", snap => {
    App.renderButtons(snap.val() || {});
    document.getElementById("lotteryBtn").onclick = App.start;
    document.getElementById("result").textContent = "";
  });
})();
</script>
</body>
</html>