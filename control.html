<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ“ä½œï¼ˆãƒ•ãƒ©ãƒƒãƒˆé’ç³»ï¼‰</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="./firebase-config.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #e3f2fd;
      color: #333;
    }
    h1, h2 {
      margin-bottom: 1em;
    }
    #nameButtons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 2em;
    }
    #nameButtons button {
      padding: 14px;
      font-size: 1em;
      border: none;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background 0.3s, transform 0.2s;
    }
    #nameButtons button:hover:not(:disabled) {
      background: #bbdefb;
      transform: scale(1.05);
      cursor: pointer;
    }
    #nameButtons button.selected {
      background: #42a5f5;
      color: white;
    }
    #nameButtons button:disabled {
      background: #eee;
      color: #999;
    }
    #result {
      font-size: 1.4em;
      margin-top: 1em;
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    #result.show {
      opacity: 1;
    }
    #lotteryBtn {
      display: block;
      margin: 0 auto;
      padding: 14px 30px;
      font-size: 1.2em;
      background: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1>å…ˆç”Ÿãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
  <h2>åå‰ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
  <div id="nameButtons"></div>

  <button id="lotteryBtn" onclick="runSeatLottery()">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹</button>
  <div id="result"></div>

  <script>
    const knownMembers = [
      "ä¸Šåœ’", "äº•ä¸Š", "ä¼Šè—¤é”", "ä¼´ç”°", "å†…æµ·", "åŠ å³¶", "åŠ è—¤", "å‹‡å£«", "åŒ—äº•", "åŒ—åŸ", "å—è¿«", "å¤å®‡ç”°",
      "å³è¡›é–€ä½", "å‰æ¾¤", "å‰ç”°æ­", "å‰ç”°é‡Œ", "åŸ", "å ¤", "å¢—ç”°", "å¤§æ©‹", "å¤§æµ¦", "å¤ªç”°å¾¹", "å¥¥å±±", "å®®ç•‘",
      "å°å³¶", "å²¡ç”°", "å²¡", "å·æ‘", "å¹³äº•", "æŠ¼å²¡", "æ˜è²", "æ±å±±", "æ±", "æ¾ä¸‹", "æ¾äº•", "æ¾æ‘", "æŸ¿æœ¨",
      "æ —æœ¬", "æ¢…æ‘", "æ£®è¥¿", "æ²³æ·»", "æ³‰è°·", "æ¸¡è¾º", "æ¾¤æœ¨", "æ¿±ç”°", "ç‰å·", "ç”°ä¸­æ„›", "ç™¾åˆé‡", "ç¦åŸ",
      "ç«‹çŸ³", "ç«¹æœ¬", "ç´€å¤ª", "èŠ±å´", "è—¤ç”°", "è±•ç€¬", "è¾»æœ¬", "è¿‘è—¤", "é‡å£", "æ¿±ä¸­"
    ];
    const totalParticipants = 70;
    const unknownMembers = Array.from({ length: totalParticipants - knownMembers.length }, (_, i) => `å‚åŠ è€…${i + 1}`);
    const allNames = [...knownMembers, ...unknownMembers];

    const allSeats = [];
    "ABCDEFG".split('').forEach(block => {
      for (let i = 1; i <= 10; i++) {
        allSeats.push(`${block}${i}`);
      }
    });

    let selectedName = null;

    function renderButtons(assigned = {}) {
      const container = document.getElementById("nameButtons");
      container.innerHTML = "";
      allNames.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.disabled = Object.keys(assigned).includes(name);
        if (!btn.disabled) {
          btn.onclick = () => {
            selectedName = name;
            document.querySelectorAll("#nameButtons button").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            const resultDiv = document.getElementById("result");
            resultDiv.textContent = `${name}å…ˆç”Ÿã‚’é¸æŠä¸­...`;
            resultDiv.classList.add("show");
          };
        }
        container.appendChild(btn);
      });
    }

    firebase.database().ref("assignments").on("value", snapshot => {
      const assigned = snapshot.val() || {};
      renderButtons(assigned);
    });

    function runSeatLottery() {
      if (!selectedName) {
        alert("å…ˆã«åå‰ã‚’é¸ã‚“ã§ãã ã•ã„");
        return;
      }

      const db = firebase.database();
      db.ref("assignments").once("value").then(snapshot => {
        const assigned = snapshot.val() || {};
        const assignedNames = Object.keys(assigned);
        const assignedSeats = Object.values(assigned);

        if (assignedNames.includes(selectedName)) {
          alert(`${selectedName}å…ˆç”Ÿã¯ã™ã§ã«å¸­ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™`);
          return;
        }

        const availableSeats = allSeats.filter(seat => !assignedSeats.includes(seat));
        if (availableSeats.length === 0) {
          alert("ç©ºãå¸­ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        let count = 0;
        const maxCount = 20;
        const interval = 100;
        const resultDiv = document.getElementById("result");

        const roulette = setInterval(() => {
          const randomSeat = availableSeats[Math.floor(Math.random() * availableSeats.length)];
          resultDiv.textContent = `${selectedName}å…ˆç”Ÿ â†’ ${randomSeat}`;
          resultDiv.classList.add("show");
          count++;
          if (count >= maxCount) {
            clearInterval(roulette);
            const finalSeat = availableSeats[Math.floor(Math.random() * availableSeats.length)];
            db.ref("assignments/" + selectedName).set(finalSeat).then(() => {
              resultDiv.textContent = `ğŸ‰ ${selectedName}å…ˆç”Ÿã®å¸­ã¯ ${finalSeat} ã«æ±ºå®šï¼`;
              resultDiv.classList.add("show");
              selectedName = null;
              renderButtons(Object.assign({}, assigned, { [selectedName]: finalSeat }));
            });
          }
        }, interval);
      });
    }
  </script>
</body>
</html>